<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂèçÂ∞ÑÁ•ûÁµå„ÉÜ„Çπ„Éà</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: rgb(0, 0, 0);
            color: #ecf0f1;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.1s;
        }

        /* --- Á©∂Ê•µ„Å´Áü≠„ÅÑ„Éï„É©„Ç§„É≥„Ç∞ÊôÇ„ÅÆ„Ç®„É©„ÉºË°®Áèæ --- */
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 0, 0, 0.4);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s ease-out;
            z-index: 100;
        }

        body.flash-error::after {
            opacity: 1;
            transition: none;
        }

        h1, h2, label, li {
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        #top-ui {
            text-align: center;
            position: absolute;
            top: 5%;
            width: 100%;
            z-index: 10;
            pointer-events: none;
        }

        h1 { margin: 0; font-size: 2rem; }

        /* --- Ë¶ñË¶ö„ÉªËÅ¥Ë¶ö„ÅÆÂàá„ÇäÊõø„Åà„Çπ„Ç§„ÉÉ„ÉÅ --- */
        #mode-switch {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            pointer-events: auto;
        }
        .mode-btn {
            padding: 8px 24px;
            background-color: transparent;
            color: #7f8c8d;
            border: 2px solid #7f8c8d;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s;
            outline: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .mode-btn.active {
            background-color: #f1c40f;
            color: #2c3e50;
            border-color: #f1c40f;
            text-shadow: none;
        }

        #center-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        #start-btn {
            pointer-events: auto;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
        }
        #start-btn:hover { background-color: #2980b9; transform: scale(1.05); }

        #result { font-size: 1.5rem; display: none; margin-bottom: 20px;}
        .score { font-size: 3.5rem; font-weight: bold; color: #f1c40f; text-shadow: 0 4px 8px rgba(0,0,0,0.9); }

        #hamburger-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 2rem;
            cursor: pointer;
            z-index: 20; 
            pointer-events: auto;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            transition: transform 0.2s;
        }

        #settings-container {
            position: absolute;
            left: -300px;
            top: 0;
            height: 100vh;
            width: 250px;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 70px 20px 20px 20px;
            box-sizing: border-box;
            z-index: 15;
            pointer-events: auto; 
            cursor: default;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            border-right: 1px solid #34495e;
        }
        
        #settings-container.open { left: 0; }

        #settings-container h2 {
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 5px;
            text-align: center;
        }

        .setting-group { margin-bottom: 25px; }
        .setting-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        
        input[type="range"] { width: 100%; cursor: pointer; margin-bottom: 10px; }

        .color-preview {
            width: 100%; height: 30px;
            border-radius: 4px;
            border: 2px solid #fff;
            box-sizing: border-box; margin-top: 5px;
        }

        #history-container {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            z-index: 10;
            pointer-events: none;
            width: 150px;
        }

        #history-container h2 { margin: 0 0 10px 0; font-size: 1.2rem; border-bottom: 1px solid #7f8c8d; padding-bottom: 5px; text-align: center; }
        #history-list { list-style: none; padding: 0; margin: 0; font-size: 1.1rem; line-height: 1.8; font-family: monospace; }

        #target-circle {
            width: 80vmin;
            height: 80vmin;
            background-color: rgb(241, 196, 15);
            border-radius: 50%;
            position: absolute;
            /* üåü „Éú„Çø„É≥„Å®Ë¢´„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´Â∞ë„Åó‰∏ã„Å´‰∏ã„Åí„Åæ„Åó„Åü */
            top: 65%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            z-index: 5;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="hamburger-btn">‚ò∞</div>

    <div id="top-ui">
        <h1>ÂèçÂ∞ÑÁ•ûÁµå„ÉÜ„Çπ„Éà</h1>
        <div id="mode-switch">
            <button id="visual-mode-btn" class="mode-btn active">Ë¶ñË¶ö</button>
            <button id="audio-mode-btn" class="mode-btn">ËÅ¥Ë¶ö</button>
        </div>
    </div>

    <div id="center-ui">
        <div id="result"></div>
        <button id="start-btn">„Çπ„Çø„Éº„Éà</button>
    </div>

    <div id="settings-container">
        <h2>„Ç´„Çπ„Çø„Éû„Ç§„Ç∫</h2>
        
        <div class="setting-group">
            <label>‰∏∏„ÅÆ„Çµ„Ç§„Ç∫: <span id="size-label">80</span>%</label>
            <input type="range" id="size-slider" min="10" max="100" value="80">
        </div>

        <div class="setting-group">
            <label>‰∏∏„ÅÆËâ≤ (RGB)</label>
            <label style="color:#ff7675;">R: <span id="r-label">241</span></label>
            <input type="range" id="r-slider" min="0" max="255" value="241">
            <label style="color:#55efc4;">G: <span id="g-label">196</span></label>
            <input type="range" id="g-slider" min="0" max="255" value="196">
            <label style="color:#74b9ff;">B: <span id="b-label">15</span></label>
            <input type="range" id="b-slider" min="0" max="255" value="15">
            <div id="color-preview" class="color-preview" style="background-color: rgb(241, 196, 15);"></div>
        </div>

        <div class="setting-group">
            <label>ËÉåÊôØ„ÅÆËâ≤ (RGB)</label>
            <label style="color:#ff7675;">R: <span id="bg-r-label">0</span></label>
            <input type="range" id="bg-r-slider" min="0" max="255" value="0">
            <label style="color:#55efc4;">G: <span id="bg-g-label">0</span></label>
            <input type="range" id="bg-g-slider" min="0" max="255" value="0">
            <label style="color:#74b9ff;">B: <span id="bg-b-label">0</span></label>
            <input type="range" id="bg-b-slider" min="0" max="255" value="0">
            <div id="bg-color-preview" class="color-preview" style="background-color: rgb(0, 0, 0);"></div>
        </div>
    </div>

    <div id="history-container">
        <h2>„Çø„Ç§„É†</h2>
        <ul id="history-list"></ul>
    </div>

    <div id="target-circle"></div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const targetCircle = document.getElementById('target-circle');
        const resultDisplay = document.getElementById('result');
        const historyList = document.getElementById('history-list');
        
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const settingsContainer = document.getElementById('settings-container');

        const visualModeBtn = document.getElementById('visual-mode-btn');
        const audioModeBtn = document.getElementById('audio-mode-btn');

        const sizeSlider = document.getElementById('size-slider');
        const sizeLabel = document.getElementById('size-label');
        const rSlider = document.getElementById('r-slider');
        const gSlider = document.getElementById('g-slider');
        const bSlider = document.getElementById('b-slider');
        const rLabel = document.getElementById('r-label');
        const gLabel = document.getElementById('g-label');
        const bLabel = document.getElementById('b-label');
        const colorPreview = document.getElementById('color-preview');

        const bgRSlider = document.getElementById('bg-r-slider');
        const bgGSlider = document.getElementById('bg-g-slider');
        const bgBSlider = document.getElementById('bg-b-slider');
        const bgRLabel = document.getElementById('bg-r-label');
        const bgGLabel = document.getElementById('bg-g-label');
        const bgBLabel = document.getElementById('bg-b-label');
        const bgColorPreview = document.getElementById('bg-color-preview');

        const MAX_TRIALS = 5;
        let trialCount = 0;
        let reactionTimes = [];
        let startTime = 0;
        let timeoutId = null;
        let currentState = 'IDLE'; 
        let currentMode = 'VISUAL'; 

        let audioCtx;
        let cueOscillator = null; // üåü È≥¥„ÇäÁ∂ö„Åë„ÇãÈü≥„ÇíÁÆ°ÁêÜ„Åô„ÇãÂ§âÊï∞

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // --- üåü ËÅ¥Ë¶ö„É¢„Éº„Éâ„ÅÆÂêàÂõ≥Èü≥ÔºàÈÄ£Á∂ö„Åó„Åü„Äå„Éî„Éº„Éº„Éº„Éº„ÄçÔºâ ---
        function playCueSound() {
            if (!audioCtx) return;
            cueOscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            cueOscillator.type = 'sine';
            cueOscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            
            cueOscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            cueOscillator.start();
            // stop()„ÇíÊåáÂÆö„Åó„Å™„ÅÑ„Åì„Å®„Åß„ÄÅ„Çø„ÉÉ„Éó„Åï„Çå„Çã„Åæ„ÅßÈ≥¥„ÇäÁ∂ö„Åë„Åæ„Åô
        }

        // --- üåü Èü≥„Çí„Éî„Çø„ÉÉ„Å®Ê≠¢„ÇÅ„ÇãÈñ¢Êï∞ ---
        function stopCueSound() {
            if (cueOscillator) {
                cueOscillator.stop();
                cueOscillator.disconnect();
                cueOscillator = null;
            }
        }

        // --- „Éï„É©„Ç§„É≥„Ç∞ÊôÇ„ÅÆ„Ç®„É©„ÉºÈü≥Ôºà‰Ωé„ÅèÂ∞è„Åï„Å™„Äå„Éú„ÉÉ„ÄçÔºâ ---
        function playErrorSound() {
            if (!audioCtx) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(100, audioCtx.currentTime);
            
            gainNode.gain.setValueAtTime(0.025, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.1); 
        }

        visualModeBtn.addEventListener('click', () => setMode('VISUAL'));
        audioModeBtn.addEventListener('click', () => setMode('AUDIO'));

        function setMode(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            
            visualModeBtn.classList.toggle('active', mode === 'VISUAL');
            audioModeBtn.classList.toggle('active', mode === 'AUDIO');
            
            clearTimeout(timeoutId);
            stopCueSound(); // „É¢„Éº„ÉâÂàáÊõøÊôÇ„Å´Èü≥„ÅåÈ≥¥„Å£„Å¶„ÅÑ„Åü„ÇâÊ≠¢„ÇÅ„Çã
            currentState = 'IDLE';
            trialCount = 0;
            reactionTimes = [];
            startBtn.style.display = 'inline-block';
            resultDisplay.style.display = 'none';
            targetCircle.style.display = 'none';
            historyList.innerHTML = '';
        }

        startBtn.addEventListener('click', startGame);
        document.addEventListener('pointerdown', handleScreenTap);

        hamburgerBtn.addEventListener('click', () => {
            settingsContainer.classList.toggle('open');
            if (settingsContainer.classList.contains('open')) {
                hamburgerBtn.textContent = '√ó';
                hamburgerBtn.style.transform = 'rotate(90deg)'; 
            } else {
                hamburgerBtn.textContent = '‚ò∞';
                hamburgerBtn.style.transform = 'rotate(0deg)';
            }
        });

        [sizeSlider, rSlider, gSlider, bSlider, bgRSlider, bgGSlider, bgBSlider].forEach(slider => {
            slider.addEventListener('input', updateSettings);
        });

        function updateSettings() {
            const size = sizeSlider.value;
            sizeLabel.textContent = size;
            targetCircle.style.width = `${size}vmin`;
            targetCircle.style.height = `${size}vmin`;

            const r = rSlider.value; const g = gSlider.value; const b = bSlider.value;
            rLabel.textContent = r; gLabel.textContent = g; bLabel.textContent = b;
            const newColor = `rgb(${r}, ${g}, ${b})`;
            colorPreview.style.backgroundColor = newColor;
            targetCircle.style.backgroundColor = newColor;

            const bgR = bgRSlider.value; const bgG = bgGSlider.value; const bgB = bgBSlider.value;
            bgRLabel.textContent = bgR; bgGLabel.textContent = bgG; bgBLabel.textContent = bgB;
            const newBgColor = `rgb(${bgR}, ${bgG}, ${bgB})`;
            bgColorPreview.style.backgroundColor = newBgColor;
            document.body.style.backgroundColor = newBgColor;
        }

        function startGame() {
            initAudio(); 

            trialCount = 0;
            reactionTimes = [];
            startBtn.style.display = 'none';
            resultDisplay.style.display = 'none';
            targetCircle.style.display = 'none'; // üåü ËÅ¥Ë¶ö„É¢„Éº„Éâ„ÅÆÂá∫„Åó„Å£„Å±„Å™„Åó„ÇíÂªÉÊ≠¢
            
            settingsContainer.classList.remove('open');
            hamburgerBtn.textContent = '‚ò∞';
            hamburgerBtn.style.transform = 'rotate(0deg)';
            
            historyList.innerHTML = '';
            for(let i = 1; i <= MAX_TRIALS; i++) {
                historyList.innerHTML += `<li id="trial-${i}">${i}ÂõûÁõÆ: --- ms</li>`;
            }

            nextTrial();
        }

        function nextTrial() {
            if (trialCount >= MAX_TRIALS) {
                showResult();
                return;
            }
            startCountdown();
        }

        function startCountdown() {
            currentState = 'WAITING';
            const randomDelay = Math.floor(Math.random() * 4000) + 3000;
            
            if (currentMode === 'VISUAL') {
                timeoutId = setTimeout(showCircle, randomDelay);
            } else {
                timeoutId = setTimeout(playCue, randomDelay);
            }
        }

        function showCircle() {
            if (currentState !== 'WAITING') return; 
            currentState = 'REACTING';
            targetCircle.style.display = 'block';
            startTime = performance.now(); 
        }

        function playCue() {
            if (currentState !== 'WAITING') return; 
            currentState = 'REACTING';
            playCueSound(); 
            startTime = performance.now(); 
        }

        function handleScreenTap(e) {
            initAudio(); 

            if (e.target.id === 'start-btn' || 
                e.target.closest('#settings-container') || 
                e.target.id === 'hamburger-btn' ||
                e.target.closest('#mode-switch')) {
                return;
            }

            if (currentState === 'WAITING') {
                clearTimeout(timeoutId);
                currentState = 'IDLE';
                
                playErrorSound(); 
                document.body.classList.add('flash-error'); 
                
                setTimeout(() => {
                    document.body.classList.remove('flash-error');
                    if (trialCount < MAX_TRIALS) {
                        setTimeout(startCountdown, 200); 
                    }
                }, 80); 

            } else if (currentState === 'REACTING') {
                // üåü „Çø„ÉÉ„Éó„Åó„ÅüÁû¨Èñì„Å´„Äå„Éî„Éº„Éº„Éº„Éº„Äç„ÇíÊ≠¢„ÇÅ„Çã
                stopCueSound();

                const endTime = performance.now();
                const reactionTime = Math.round(endTime - startTime);
                reactionTimes.push(reactionTime);
                
                if (currentMode === 'VISUAL') {
                    targetCircle.style.display = 'none';
                }
                
                currentState = 'IDLE';
                
                const listItem = document.getElementById(`trial-${trialCount + 1}`);
                if(listItem) {
                    listItem.textContent = `${trialCount + 1}ÂõûÁõÆ: ${reactionTime} ms`;
                }

                trialCount++;
                setTimeout(nextTrial, 500);
            }
        }

        function showResult() {
            currentState = 'IDLE';
            targetCircle.style.display = 'none'; 
            stopCueSound(); // Âøµ„ÅÆ„Åü„ÇÅÁµÇ‰∫ÜÊôÇ„Å´„ÇÇÈü≥„ÇíÊ≠¢„ÇÅ„Çã
            
            const sum = reactionTimes.reduce((a, b) => a + b, 0);
            const average = sum / MAX_TRIALS;
            
            resultDisplay.innerHTML = `Âπ≥ÂùáÂèçÂøúÈÄüÂ∫¶<br><span class="score">${Math.round(average)}</span> ms`;
            resultDisplay.style.display = 'block';
            
            startBtn.textContent = '„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§';
            startBtn.style.display = 'inline-block';
        }
    </script>
</body>
</html>

