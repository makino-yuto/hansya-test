<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>反射神経テスト</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
            background-color: rgb(0, 0, 0);
            color: #ecf0f1;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 0.1s;
        }

        /* フライング時の赤いフラッシュ効果（文字なしでエラーを伝えるため） */
        .flash-error {
            background-color: #c0392b !important;
            transition: none !important; /* 一瞬で赤くする */
        }

        h1, h2, label, li {
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        #top-ui {
            text-align: center;
            position: absolute;
            top: 5%;
            width: 100%;
            z-index: 10;
            pointer-events: none;
        }

        h1 { margin: 0; font-size: 2rem; }

        #center-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }

        button {
            pointer-events: auto;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 6px 12px rgba(0,0,0,0.5);
        }
        button:hover { background-color: #2980b9; transform: scale(1.05); }

        #result { font-size: 1.5rem; display: none; margin-bottom: 20px;}
        .score { font-size: 3.5rem; font-weight: bold; color: #f1c40f; text-shadow: 0 4px 8px rgba(0,0,0,0.9); }

        #hamburger-btn {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 2rem;
            cursor: pointer;
            z-index: 20; 
            pointer-events: auto;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            transition: transform 0.2s;
        }

        #settings-container {
            position: absolute;
            left: -300px;
            top: 0;
            height: 100vh;
            width: 250px;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 70px 20px 20px 20px;
            box-sizing: border-box;
            z-index: 15;
            pointer-events: auto; 
            cursor: default;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            border-right: 1px solid #34495e;
        }
        
        #settings-container.open { left: 0; }

        #settings-container h2 {
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 5px;
            text-align: center;
        }

        .setting-group { margin-bottom: 25px; }
        .setting-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        
        input[type="range"] { width: 100%; cursor: pointer; margin-bottom: 10px; }

        .color-preview {
            width: 100%; height: 30px;
            border-radius: 4px;
            border: 2px solid #fff;
            box-sizing: border-box; margin-top: 5px;
        }

        #history-container {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            z-index: 10;
            pointer-events: none;
            width: 150px;
        }

        #history-container h2 { margin: 0 0 10px 0; font-size: 1.2rem; border-bottom: 1px solid #7f8c8d; padding-bottom: 5px; text-align: center; }
        #history-list { list-style: none; padding: 0; margin: 0; font-size: 1.1rem; line-height: 1.8; font-family: monospace; }

        #target-circle {
            width: 80vmin;
            height: 80vmin;
            background-color: rgb(241, 196, 15);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            z-index: 5;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="hamburger-btn">☰</div>

    <div id="top-ui">
        <h1>反射神経テスト</h1>
    </div>

    <div id="center-ui">
        <div id="result"></div>
        <button id="start-btn">スタート</button>
    </div>

    <div id="settings-container">
        <h2>カスタマイズ</h2>
        
        <div class="setting-group">
            <label>丸のサイズ: <span id="size-label">80</span>%</label>
            <input type="range" id="size-slider" min="10" max="100" value="80">
        </div>

        <div class="setting-group">
            <label>丸の色 (RGB)</label>
            <label style="color:#ff7675;">R: <span id="r-label">241</span></label>
            <input type="range" id="r-slider" min="0" max="255" value="241">
            <label style="color:#55efc4;">G: <span id="g-label">196</span></label>
            <input type="range" id="g-slider" min="0" max="255" value="196">
            <label style="color:#74b9ff;">B: <span id="b-label">15</span></label>
            <input type="range" id="b-slider" min="0" max="255" value="15">
            <div id="color-preview" class="color-preview" style="background-color: rgb(241, 196, 15);"></div>
        </div>

        <div class="setting-group">
            <label>背景の色 (RGB)</label>
            <label style="color:#ff7675;">R: <span id="bg-r-label">0</span></label>
            <input type="range" id="bg-r-slider" min="0" max="255" value="0">
            <label style="color:#55efc4;">G: <span id="bg-g-label">0</span></label>
            <input type="range" id="bg-g-slider" min="0" max="255" value="0">
            <label style="color:#74b9ff;">B: <span id="bg-b-label">0</span></label>
            <input type="range" id="bg-b-slider" min="0" max="255" value="0">
            <div id="bg-color-preview" class="color-preview" style="background-color: rgb(0, 0, 0);"></div>
        </div>
    </div>

    <div id="history-container">
        <h2>タイム</h2>
        <ul id="history-list"></ul>
    </div>

    <div id="target-circle"></div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const targetCircle = document.getElementById('target-circle');
        const resultDisplay = document.getElementById('result');
        const historyList = document.getElementById('history-list');
        
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const settingsContainer = document.getElementById('settings-container');

        const sizeSlider = document.getElementById('size-slider');
        const sizeLabel = document.getElementById('size-label');
        const rSlider = document.getElementById('r-slider');
        const gSlider = document.getElementById('g-slider');
        const bSlider = document.getElementById('b-slider');
        const rLabel = document.getElementById('r-label');
        const gLabel = document.getElementById('g-label');
        const bLabel = document.getElementById('b-label');
        const colorPreview = document.getElementById('color-preview');

        const bgRSlider = document.getElementById('bg-r-slider');
        const bgGSlider = document.getElementById('bg-g-slider');
        const bgBSlider = document.getElementById('bg-b-slider');
        const bgRLabel = document.getElementById('bg-r-label');
        const bgGLabel = document.getElementById('bg-g-label');
        const bgBLabel = document.getElementById('bg-b-label');
        const bgColorPreview = document.getElementById('bg-color-preview');

        const MAX_TRIALS = 5;
        let trialCount = 0;
        let reactionTimes = [];
        let startTime = 0;
        let timeoutId = null;
        let currentState = 'IDLE'; 

        startBtn.addEventListener('click', startGame);
        document.addEventListener('pointerdown', handleScreenTap);

        hamburgerBtn.addEventListener('click', () => {
            settingsContainer.classList.toggle('open');
            if (settingsContainer.classList.contains('open')) {
                hamburgerBtn.textContent = '×';
                hamburgerBtn.style.transform = 'rotate(90deg)'; 
            } else {
                hamburgerBtn.textContent = '☰';
                hamburgerBtn.style.transform = 'rotate(0deg)';
            }
        });

        [sizeSlider, rSlider, gSlider, bSlider, bgRSlider, bgGSlider, bgBSlider].forEach(slider => {
            slider.addEventListener('input', updateSettings);
        });

        function updateSettings() {
            const size = sizeSlider.value;
            sizeLabel.textContent = size;
            targetCircle.style.width = `${size}vmin`;
            targetCircle.style.height = `${size}vmin`;

            const r = rSlider.value; const g = gSlider.value; const b = bSlider.value;
            rLabel.textContent = r; gLabel.textContent = g; bLabel.textContent = b;
            const newColor = `rgb(${r}, ${g}, ${b})`;
            colorPreview.style.backgroundColor = newColor;
            targetCircle.style.backgroundColor = newColor;

            const bgR = bgRSlider.value; const bgG = bgGSlider.value; const bgB = bgBSlider.value;
            bgRLabel.textContent = bgR; bgGLabel.textContent = bgG; bgBLabel.textContent = bgB;
            const newBgColor = `rgb(${bgR}, ${bgG}, ${bgB})`;
            bgColorPreview.style.backgroundColor = newBgColor;
            document.body.style.backgroundColor = newBgColor;
        }

        function startGame() {
            trialCount = 0;
            reactionTimes = [];
            startBtn.style.display = 'none';
            resultDisplay.style.display = 'none';
            
            settingsContainer.classList.remove('open');
            hamburgerBtn.textContent = '☰';
            hamburgerBtn.style.transform = 'rotate(0deg)';
            
            historyList.innerHTML = '';
            for(let i = 1; i <= MAX_TRIALS; i++) {
                historyList.innerHTML += `<li id="trial-${i}">${i}回目: --- ms</li>`;
            }
            nextTrial();
        }

        function nextTrial() {
            if (trialCount >= MAX_TRIALS) {
                showResult();
                return;
            }
            startCountdown();
        }

        function startCountdown() {
            currentState = 'WAITING';
            const randomDelay = Math.floor(Math.random() * 4000) + 3000;
            timeoutId = setTimeout(showCircle, randomDelay);
        }

        function showCircle() {
            if (currentState !== 'WAITING') return; 
            
            currentState = 'REACTING';
            targetCircle.style.display = 'block';
            startTime = performance.now(); 
        }

        function handleScreenTap(e) {
            if (e.target.id === 'start-btn' || 
                e.target.closest('#settings-container') || 
                e.target.id === 'hamburger-btn') {
                return;
            }

            if (currentState === 'WAITING') {
                // フライング処理：文字は出さず、画面を一瞬赤くフラッシュさせる
                clearTimeout(timeoutId);
                currentState = 'IDLE';
                
                document.body.classList.add('flash-error');
                
                setTimeout(() => {
                    document.body.classList.remove('flash-error');
                    if (trialCount < MAX_TRIALS) {
                        // フラッシュ後、少しだけ間を空けて静かにカウントダウン再開
                        setTimeout(startCountdown, 500);
                    }
                }, 200); // 0.2秒だけ赤く光る

            } else if (currentState === 'REACTING') {
                const endTime = performance.now();
                const reactionTime = Math.round(endTime - startTime);
                reactionTimes.push(reactionTime);
                
                targetCircle.style.display = 'none';
                currentState = 'IDLE';
                
                const listItem = document.getElementById(`trial-${trialCount + 1}`);
                if(listItem) {
                    listItem.textContent = `${trialCount + 1}回目: ${reactionTime} ms`;
                }

                trialCount++;
                setTimeout(nextTrial, 500);
            }
        }

        function showResult() {
            currentState = 'IDLE';
            targetCircle.style.display = 'none';
            
            const sum = reactionTimes.reduce((a, b) => a + b, 0);
            const average = sum / MAX_TRIALS;
            
            resultDisplay.innerHTML = `平均反応速度<br><span class="score">${Math.round(average)}</span> ms`;
            resultDisplay.style.display = 'block';
            
            startBtn.textContent = 'もう一度プレイ';
            startBtn.style.display = 'inline-block';
        }
    </script>
</body>
</html>
